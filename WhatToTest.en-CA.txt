Poker Dealer - Initial Release
================================

What's New:
-----------
- Complete Texas Hold'em digital dealer application
- Support for up to 10 simultaneous players
- Real-time WebSocket communication for instant updates
- Mobile-responsive design for phones and tablets
- Automatic dealer rotation after each hand
- Public community cards display for shared screens (no authentication required)

Latest Changes (2025-12-01):
----------------------------
- **Configurable Reset Challenge Phrase**
  - Game reset challenge phrase is now loaded from RESET_PHRASE environment variable
  - Maintains backward compatibility with default value "milliken mills posse" if environment variable is not set
  - Allows production deployments to use custom reset phrase via Digital Ocean App Platform environment variables
  - Updated server/routes/game.js to read from process.env.RESET_PHRASE
  - Local development uses .env file for configuration

Previous Changes (2025-11-30):
------------------------------
- **NEW: User-Specific JWT Tokens for Video Conferencing**
  - Replaced hardcoded JWT token with user-specific tokens loaded from environment variables
  - Each user (Gary, Neave, Harish, Chris, Tony, Seymour, Kerwin, Wayne, Dee, Lorenzo, JB) has their own JWT token
  - Community display page uses a shared JWT_COMMUNITY token
  - Implemented server-side rendering with EJS templates to inject JWT tokens securely
  - JWT tokens are no longer exposed in client-side HTML source code
  - Environment variables configured via Digital Ocean App Platform dashboard for production
  - Added dotenv support for local development environment variable loading
  - Server validates JWT configuration on startup and warns if any tokens are missing
  - Files created: views/game.ejs, views/community.ejs, server/jwt-config.js
  - Dependencies added: ejs@^3.1.9, dotenv@^16.3.1

Previous Changes (2025-11-29):
------------------------------
- **Footer Added to All Pages**
  - Added footer "Made with üíï in the 6ix" to login, game, and community pages
  - Footer is centered and styled with subtle opacity for a clean look
  - Responsive design ensures footer displays correctly on all devices

- **Protected Game Reset Endpoint**
  - Added "Reset Game" button in the game page header
  - Reset requires entering the challenge phrase: "milliken mills posse" (case-insensitive)
  - Confirmation dialog prevents accidental resets
  - Resets game state, clears all player positions, and logs out all users
  - All connected clients are notified via WebSocket and redirected to login
  - API endpoint: POST /api/game/reset with challengePhrase in request body

- **NEW: Simplified Authentication Flow**
  - Removed username/password requirement for login
  - Users now select from a dropdown list of available players
  - Display name field allows users to view and update their display name before joining
  - Already logged-in users are indicated with a ‚ö†Ô∏è symbol in the dropdown
  - Warning message displays when selecting an already logged-in user (but login is still allowed)
  - No passwords needed - the app is designed for casual, fun play with no critical resources
  - Multiple sessions allowed for the same user across different devices

Previous Changes (2025-11-27):
------------------------------
- **Video Toggle Control**
  - Added "Show Video" checkbox in the header to show/hide the Jitsi video conference section
  - Video section is hidden by default when the page loads for better performance
  - Toggle the checkbox to show/hide the video conference area
  - Useful for conserving bandwidth when video is not needed
- Card suit symbols now display in appropriate colors (hearts/diamonds in red, clubs/spades in black)
- Applies to both player view and public community display
- Added `--reset` command line flag to reset game state and log out all users
  - Usage: `npm run start:reset` or `node server/index.js --reset`
  - Clears all active game data (players, cards, dealer position)
  - Logs out all users by clearing all sessions
  - Useful for starting fresh game sessions or testing
- **Player Removal on Logout**
  - When a user logs out, they are automatically removed from the active player list
  - Prevents logged-out users from being accidentally selected as dealer
  - Game state updates in real-time for all remaining players
- **Manual Dealer Selection**
  - Added "Choose Dealer" button in the Players section
  - Button is only enabled when:
    * At least one player has joined the game
    * No dealer has been selected yet
    * No cards have been dealt
  - Clicking the button randomly selects the first dealer from all logged-in players
  - Once a dealer is selected, the button becomes disabled
  - Button remains disabled until the server is restarted with `--reset` flag
  - Automatic dealer rotation for subsequent hands continues to work as before

Previous Bug Fixes (2025-11-26):
---------------------------------
- Fixed cookie path issue preventing session cookies from being sent with all requests
- Added explicit `path: '/'` to all cookie operations to ensure site-wide availability
- Fixed httpOnly cookie access issue by returning token in /api/auth/session response
- Removed client-side getSessionToken() function that couldn't access httpOnly cookies
- WebSocket authentication now uses token from API response instead of trying to read cookie
- Fixed login infinite loop by removing automatic checkSession() redirect
- Added `credentials: 'same-origin'` to all fetch API calls for cookie support
- Changed cookie sameSite from 'strict' to 'lax' to allow cookies on navigation redirects

Key Features to Test:
--------------------

1. Authentication & Login
   - Select a user from the dropdown list (Gary, Neave, Harish, Chris, Tony, Seymour, Kerwin, Wayne, Dee, Lorenzo)
   - View and optionally update the display name before joining
   - Verify already logged-in users are indicated with ‚ö†Ô∏è symbol in dropdown
   - Verify warning message appears when selecting an already logged-in user
   - Verify users can still login even when already logged in elsewhere (multiple sessions allowed)
   - Logout functionality
   - Session persistence across page refreshes
   - Test that display name updates are saved and persist

2. Game Setup
   - Join game before cards are dealt
   - Verify you cannot join once cards have been dealt
   - Check that players appear in the order they joined
   - Click "Choose Dealer" button to randomly select first dealer
   - Verify "Choose Dealer" button is disabled when no players present
   - Verify "Choose Dealer" button is disabled after dealer is selected
   - Verify "Choose Dealer" button is disabled after cards are dealt

3. Dealer Controls (Dealer Only)
   - "Deal Cards" button distributes 2 hole cards to each player
   - "Deal Cards" button also deals 5 community cards (face down)
   - "Flip" button reveals cards in correct sequence:
     * First click: Reveals Flop (3 cards)
     * Second click: Reveals Turn (1 card)
     * Third click: Reveals River (1 card)
     * Fourth click: Completes hand and rotates dealer
   - Verify only the current dealer can see dealer controls
   - Verify only the current dealer can use dealer actions

4. Card Display
   - Community cards visible to all players
   - Hole cards visible only to the player who owns them
   - Card backs shown for unrevealed community cards
   - Proper card suit symbols (‚ô† ‚ô• ‚ô¶ ‚ô£)

5. Multi-Device Testing
   - Test with 2-10 devices simultaneously
   - Verify real-time updates across all devices
   - Check WebSocket reconnection if connection drops
   - Test on different browsers (Chrome, Safari, Firefox)
   - Test on mobile devices (iOS and Android)

6. Game Flow
   - Complete a full hand from deal to river
   - Verify dealer rotates to next player after hand completion
   - Play multiple consecutive hands
   - Confirm dealer button moves clockwise around the table

7. Player List
   - All connected players shown
   - Current dealer indicated with "DEALER" badge
   - Player order matches join order
   - Players are removed from list when they log out
   - Game state updates immediately when a player leaves

8. Video Conference Toggle
   - Video section is hidden by default when page loads
   - "Show Video" checkbox in header is visible
   - Clicking checkbox reveals the Jitsi video conference section
   - Unchecking checkbox hides the video section
   - Toggle works smoothly without page reload

9. Responsive Design
   - Login page displays correctly on mobile
   - Game interface adapts to different screen sizes
   - Cards scale appropriately on smaller screens
   - All buttons accessible on touch devices

10. Connection Status
    - Connection indicator in bottom right
    - Shows "Connected" in green when WebSocket active
    - Shows "Disconnected" in red when connection lost

11. Error Handling
    - Cannot join game after cards dealt (shows error message)
    - Cannot deal cards if not the dealer
    - Cannot flip cards if not the dealer
    - Appropriate error messages for invalid actions

Known Limitations:
-----------------
- Betting is handled outside the app (in-person)
- No hand evaluation or winner determination
- No chip tracking or pot management
- Single game instance (all players join the same game)
- Test accounts use default password (change in production)

Test Scenarios:
--------------

Scenario 1: Two-Player Quick Game
1. On device 1, select "Gary" from dropdown, optionally update display name, click "Join Game"
2. On device 2, select "Neave" from dropdown, optionally update display name, click "Join Game"
3. Both players should now be in the game
4. Click "Choose Dealer" button to randomly select first dealer
5. Dealer clicks "Deal Cards"
6. Verify each player sees their own hole cards
7. Dealer clicks "Flip" four times (Flop, Turn, River, Complete)
8. Verify dealer has rotated to other player
9. Deal another hand

Scenario 2: Full Table (10 Players)
1. Login with all 10 available users (Gary, Neave, Harish, Chris, Tony, Seymour, Kerwin, Wayne, Dee, Lorenzo) on different devices
2. All join game in sequence
3. Verify player order matches join order
4. Deal cards and complete a full hand
5. Verify dealer rotation through all players

Scenario 3: Mid-Game Join Attempt
1. Have 3 players join
2. Dealer deals cards
3. Attempt to join with 4th player
4. Verify join is rejected with appropriate message

Scenario 4: Connection Resilience
1. Start a game with multiple players
2. Disconnect one player's internet
3. Reconnect the player
4. Verify game state syncs correctly

Scenario 5: Mobile Gameplay
1. Login on iOS Safari
2. Login on Android Chrome
3. Complete a full game using only mobile devices
4. Verify all controls are accessible via touch

Scenario 7: Player Logout During Setup
1. Login as Gary, Neave, and Harish on three different devices
2. All three join the game
3. Neave logs out before dealer is selected
4. Verify Neave is removed from player list on all devices
5. On a 4th device, verify Neave now appears as available to login in the dropdown
6. Click "Choose Dealer" - verify only Gary or Harish can be selected
7. Complete the game with remaining players

Scenario 10: Multiple Login Warning
1. Login as Gary on device 1 and join the game
2. On device 2, open the login page
3. Verify Gary appears in the dropdown with a ‚ö†Ô∏è warning symbol
4. Select Gary from the dropdown
5. Verify a warning message appears: "‚ö†Ô∏è This user is already logged in on another device. Logging in will create a second session."
6. Click "Join Game" and verify login succeeds (multiple sessions allowed)
7. Verify both devices are now logged in as Gary
8. Logout Gary on device 1
9. Refresh the login page on a device 3
10. Verify Gary still shows ‚ö†Ô∏è symbol (device 2 still logged in)

Scenario 11: Display Name Updates
1. Login as Gary on device 1
2. Before submitting, change the display name from "Gary" to "Gary the Great"
3. Click "Join Game"
4. On device 2, login as Neave
5. Verify Gary's display name shows as "Gary the Great" in the player list
6. Gary logs out and logs back in
7. Verify the display name field shows "Gary the Great" (persisted)
8. Change it back to "Gary" and join
9. Verify the updated name appears to all players

Scenario 12: Game Reset with Challenge Phrase
1. Login with 3-4 players and start a game
2. Deal cards and progress through a few rounds
3. One player clicks the "Reset Game" button in the header
4. Verify a prompt appears asking for the challenge phrase
5. Enter an incorrect phrase (e.g., "wrong phrase")
6. Verify an error message appears: "Invalid challenge phrase"
7. Click "Reset Game" button again
8. Enter the correct phrase: "milliken mills posse" (test case-insensitivity)
9. Verify a confirmation dialog appears
10. Click "Cancel" - verify nothing happens
11. Click "Reset Game" again, enter correct phrase, click "OK"
12. Verify success message appears
13. Verify all connected clients are redirected to login page
14. Login again and verify game state is reset (no players, no cards, no dealer)

Scenario 13: Game Reset via API
1. Use curl or Postman to test the API endpoint directly
2. Send POST request to /api/game/reset without challengePhrase
3. Verify 400 error: "Challenge phrase is required"
4. Send POST with incorrect phrase
5. Verify 403 error: "Invalid challenge phrase"
6. Send POST with correct phrase: {"challengePhrase": "Milliken Mills Posse"}
7. Verify 200 success response
8. Verify game state has been reset in database

Scenario 8: Manual Dealer Selection
1. Start server with `--reset` flag to ensure clean state
2. Login with 3-4 players
3. All players join game
4. Verify "Choose Dealer" button is enabled
5. Click "Choose Dealer" button
6. Verify a random player is selected as dealer
7. Verify "Choose Dealer" button becomes disabled
8. Complete hand and verify automatic dealer rotation still works
9. Verify "Choose Dealer" button remains disabled for subsequent hands

Scenario 9: Video Toggle Control
1. Login and navigate to the game page
2. Verify video conference section is hidden by default
3. Locate "Show Video" checkbox in the header
4. Click checkbox to enable video
5. Verify Jitsi video conference section appears
6. Verify video loads correctly
7. Uncheck the "Show Video" checkbox
8. Verify video section is hidden again
9. Test toggle multiple times to ensure it works reliably

Scenario 6: Public Community Display
1. On a shared screen/TV, navigate to `/community`
2. Verify no authentication is required
3. On player devices, login and join game
4. Dealer deals cards
5. Verify community cards appear immediately on public display
6. Dealer flips through Flop, Turn, River
7. Verify public display updates in real-time
8. Check that public display does NOT show hole cards
9. Test display on different screen sizes (phone, tablet, TV)

Important Notes:
---------------
- Always test with multiple devices/browsers simultaneously
- Check browser console for JavaScript errors
- Monitor WebSocket connection in network tab
- Test both portrait and landscape orientations on mobile
- Verify session persistence after page refresh

For Issues:
----------
- Check browser console for errors
- Verify WebSocket connection status
- Review server logs if running locally
- Ensure all players are on the same network (if testing locally)
